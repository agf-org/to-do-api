build_develop:
  stage: build
  environment:
    name: development
    action: prepare
  rules:
    - if: ($CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "master")
  script:
    - docker pull $CI_REGISTRY_IMAGE:develop || true
    - > 
      docker build
      --cache-from $CI_REGISTRY_IMAGE:develop
      --tag $CI_REGISTRY_IMAGE:develop
      .
    - docker push $CI_REGISTRY_IMAGE:develop

deploy_develop:
  stage: deploy
  variables:
    GIT_STRATEGY: none
  environment:
    name: development
    action: start
    on_stop: manual_stop_develop
  rules:
    - if: ($CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "master")
  script:
    - docker container stop develop_to-do-api || true
    - docker container rm develop_to-do-api || true
    - echo "NODE_ENV=$NODE_ENV" >> .env
    - >
      docker container run
      --env-file .env
      --publish $PORT:3000
      --name develop_to-do-api
      --detach
      --restart unless-stopped
      $CI_REGISTRY_IMAGE:develop
      start
    - rm .env

manual_stop_develop:
  stage: deploy
  variables:
    GIT_STRATEGY: none
  environment:
    name: development
    action: stop
  rules:
    - if: ($CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "master")
      when: manual
      allow_failure: true
  script:
    - docker container stop develop_to-do-api || true
    - docker container rm develop_to-do-api || true
